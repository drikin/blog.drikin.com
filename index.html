<!DOCTYPE html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>[D]&nbsp;<$mt:EntryTitle encode_html="1"$></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Facebook {{{ -->
        <meta property="og:title" content="<$mt:BlogName encode_html='1'$>">
        <!-- <meta property="og:description" content=""> -->
        <!-- <meta property="og:image" content=""> -->
        <!-- }}} -->

        <!-- Twitter {{{ -->
        <meta name="twitter:card" content="summary">
        <!-- <meta name="twitter:site" content="@site_account"> -->
        <meta name="twitter:creator" content="@drikin">
        <!-- <meta name="twitter:url" content="http://www.example.com/path/to/page.html"> -->
        <meta name="twitter:title" content="<$mt:BlogName encode_html='1'$>">
        <!-- <meta name="twitter:description" content=""> -->
        <!-- <meta name="twitter:image" content="http://www.example.com/path/to/image.jpg"> -->
        <!-- }}} -->

        <!-- Place favicon.ico and apple-touch-icon(s) in the root directory -->

        <!-- DNS prefetch {{{ -->
        <link rel="dns-prefetch" href="//ajax.googleapis.com">
        <link rel="dns-prefetch" href="//www.flickr.com">
        <link rel="dns-prefetch" href="//twitter.com">
        <link rel="dns-prefetch" href="//developers.facebook.com">
        <link rel="dns-prefetch" href="//b.hatena.ne.jp">
        <link rel="dns-prefetch" href="//apis.google.com">
        <link rel="dns-prefetch" href="//widgets.getpocket.com">
        <link rel="dns-prefetch" href="//farm1.staticflickr.com">
        <link rel="dns-prefetch" href="//farm2.staticflickr.com">
        <link rel="dns-prefetch" href="//farm3.staticflickr.com">
        <link rel="dns-prefetch" href="//farm4.staticflickr.com">
        <link rel="dns-prefetch" href="//farm5.staticflickr.com">
        <link rel="dns-prefetch" href="//farm6.staticflickr.com">
        <link rel="dns-prefetch" href="//farm7.staticflickr.com">
        <link rel="dns-prefetch" href="//farm8.staticflickr.com">
        <link rel="dns-prefetch" href="//farm9.staticflickr.com">
        <!-- }}} -->

        <link rel="stylesheet" href="/css/normalize.css">
        <link rel="stylesheet" href="/css/main.css">

        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/DriftDiary13">
        <link rel="alternate" type="application/atom+xml" title="Atom" href="http://feeds.feedburner.com/DriftDiary13">

        <mt:EntryPrevious><link rel="prev bookmark" href="<$mt:EntryPermalink$>" title="<$mt:EntryTitle encode_html='1'$>" /></mt:EntryPrevious>
        <mt:EntryNext><link rel="next bookmark" href="<$mt:EntryPermalink$>" title="<$mt:EntryTitle encode_html='1'$>" /></mt:EntryNext>

        <script src="/js/vendor/modernizr-2.7.0.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <!-- Facebook SDK {{{ -->
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1&appId=123966144389977";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>
        <!-- Facebook SDK }}} -->

        <!-- Add your site or application content here -->
        <div id='top' class='flex flex-vertical-center flex-horizontal-space-between'>
            <div id='title'>
                <!--<a href="<$mt:BlogURL$>" accesskey='1'><$mt:BlogName encode_html='1'$></a>-->
                <a href="<$mt:BlogURL$>" accesskey='1'>
                    <img id='title-face' src='/img/drikin-face.png'>
                    <img id='title-logo' src='/img/driftdiarylogo.png'>
                </a>
            </div>
            <div id='social-button-top'>
                <a href='https://twitter.com/share' target="_blank"><img class='social-icon-top' src='/img/Twitter_logo_blue.png'></a>
                <a href='http://www.facebook.com/sharer.php?u=<$MTEntryPermalink$>&amp;t=<$mt:EntryTitle encode_html="1"$>' rel="nofollow" target="_blank"><img class='social-icon-top' src='/img/FB-f-Logo__blue_72.png'></a>
                <a href="http://b.hatena.ne.jp/entry/add/<$MTEntryPermalink$>" target="_blank"><img class='social-icon-top' src='/img/bbtn-s_v3@2x.png'></a>
            </div>
        </div>
        <div id='middle' class='flex center'>
            <div id='left' class='flex-nowrap flex-horizontal-center'>
                    <!-- Hatena {{{ -->
                    <div id='hatena'>
                        <script language="javascript" type="text/javascript" src="http://b.hatena.ne.jp/js/widget.js" charset="utf-8"></script>
                        <script language="javascript" type="text/javascript">
                            Hatena.BookmarkWidget.url   = "blog.drikin.com";
                            Hatena.BookmarkWidget.title = "人気のエントリー";
                            Hatena.BookmarkWidget.sort  = "hot";
                            Hatena.BookmarkWidget.width = 0;
                            Hatena.BookmarkWidget.num   = 10;
                            Hatena.BookmarkWidget.theme = "hatenadiary";
                            Hatena.BookmarkWidget.load();
                        </script>
                    </div>
                    <!-- Hatena }}} -->

                    <!-- Adsense Left {{{ -->
                    <div id='adsense-left'>
                        <!-- HTML Boilerplate Left -->
                        <ins class="adsbygoogle html-boilerplate-left"
                            style="display:inline-block"
                            data-ad-client="ca-pub-2861930620315189"
                            data-ad-slot="8558140251"></ins>
                        <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                    <!-- Adsense Left }}} -->
            </div>
            <div id='center'>
                <div id='content'>

                    <!-- Dummy Content {{{ -->
                    <mt:ignore>

<div id="content">

                    <!-- Dummy Content {{{ -->
                    
<!-- Dummy Content }}} -->

                    <h1>Mavericks Safariを以前のサクサク軽快Safariに戻す方法</h1>
                    <div id='post-info' class='sub-text'>
                        
                            Posted by <span class="vcard author"><a class="fn url" href="http://blog.drikin.com/">drikin</a></span> on <abbr class="published" title="2013-12-08T08:53:52+09:00">2013年12月 8日 08:53</abbr>
                        
                    </div>

                    
                        <div class="markdown">
<p><img src="http://farm8.staticflickr.com/7349/11229329733_3571320759_c.jpg" alt="_SDI0117.jpg" title=""></p>

</div>
                    

                    
                        <p>出張初日から飛ばしすぎて連日鼻血は出るし、なんか既にスタミナが空な感じなんですが、ブログリハビリ中でようやく更新ペースが戻ってきたので勢いを落とさないように軽めのエントリー。（と思って書き始めたらむしろ長いエントリーになったｗ）</p>

<p><img src="http://farm3.staticflickr.com/2873/11229472416_31d919524d_c.jpg" alt="Screen Shot 2013-12-06 at 10.13.16 AM" title=""></p>

<p>一枚目の写真は本文には全く関係なくて、注目していただきたいのは↑の写真。</p>

<h2>問題</h2>

<p>不覚にも昨日まで気づかなかったんですが、気づいたらMavericksのSafari 7ってタブ毎にプロセスを生成するGoogle Chromeスタイルにアーキテクチャが変わってたんですね。</p>

<p>もともと、Safariが採用しているWebKitというエンジンはシングルプロセスモデルで、それだと１つのタブがクラッシュしただけでアプリ巻き込んでしまうのが安定性として問題ってことで、Google Chromeは独自にWebKitを拡張して、タブごとにプロセスを生成するモデルにいち早く切り替えました。本家WebKitもWebKit2を開発。Safari 5.1でようやくUIとレンダリングのプロセス切り離しに成功しました。Google Chromeとはアプローチは違うものの、タブがクラッシュしてもSafari自体は生き残れるようになったんですが、<strong>MavericksのSafari 7ではタブ毎にプロセスを立ち上げるまさにGoogle Chromeモデルに切り替え</strong>たんですね。</p>

<p>オリジナルのWebKit2のプロセスモデルとGoogle Chromeのプロセスモデルと、どっちにも長所短所があって、どちらが正しいとか断言するのは難しいんですが、個人的には旧WebKit2のぽプロセスモデルはバランスが良くて悪くないなと思ってたのでちょっと残念。</p>

<p>だって、タブ開くたびにものすごいメモリー消費していくんですよ。去年Google ChromeからSafariに戻った大きな理由の１つは<strong>Chromeメモリ食い過ぎ</strong>ってことだったのに、Safariも同じ穴のムジナになっちゃったよ。</p>

<p>MacBook Pro RetinaになってからSafariのタブ開くのが妙に重くなったなぁとか思ってたんですが、MBPRの問題ではなくて、このアーキテクチャ変更が問題だったようです。</p>

<p>いくらMarvericksで圧縮メモリー機能を搭載して、実メモリの1.5倍程度はメモリーが有効に使えるようになったとはいえ、タブ毎に軽く100MBくらいメモリー取られると<strong>10タブで1GB</strong>ですよ。さすがにちょっと富豪すぎ。</p>

<p>別にいまどきそうそうコンテンツがクラッシュする頻度も少なくなったし、仮にクラッシュして、全タブ巻き込んでリロードが走っても読み込みが早いので、むしろメモリーがクリーンになって良かったくらいに思ってたので、前のアーキテクチャのほうが好きだったなぁ。</p>

<p>もちろん将来的にもっともっとメモリーやCPUがリッチになっていけば、タブ毎にプロセス作るなんて無視できるコストになると思うけど、現状は明らかに重くなってるもん。</p>

<h2>対策</h2>

<p>ってことで、前置きが長くなりましたがここからが対策です。</p>

<p>上級マックユーザーにはおなじみだと思いますが、ターミナルを開いて↓のコマンドを実行して、一旦Safariを再起動すると、Safarino再起動後にデバッグメニューが出現します。</p>

<p>defaults write com.apple.Safari IncludeInternalDebugMenu 1</p>

<p><a href="http://www.flickr.com/photos/drikin/11229638705" title="Screen Shot 2013-12-06 at 10.34.37 AM by Kohichi Aoki, on Flickr"><img src="http://farm4.staticflickr.com/3777/11229638705_fa981c897f_n.jpg" width="202" height="320" alt="Screen Shot 2013-12-06 at 10.34.37 AM"></a></p>

<p>↑このメニューの1つめにある<strong>Disable Per-Tab Web Processes</strong>っていうメニューのチェックを有効にすると旧来のWebKit2プロセスモデルに戻すことができます。</p>

<p>これでキビキビ動くSafariが帰ってきました。</p>

<p><img src="http://farm4.staticflickr.com/3755/11229634385_db3f569b98_c.jpg" alt="Screen Shot 2013-12-06 at 10.33.26 AM" title=""></p>

<p>実際に2枚目のスクリーンショットと同じタブを開いた状態でのメモリー使用量を測定してみると500MB弱に。</p>

<p>タブ毎にプロセスを立ち上げてた時はタブ毎のメモリー使用量の合計が軽く1GB超えてたので、<strong>メモリー使用量が半分以上削減</strong>した結果に！</p>

<p>ちなみに戻すときは</p>

<p>defaults write com.apple.Safari IncludeInternalDebugMenu 0</p>

<p>で内部デバッグメニューが非表示になります。ちなみに変えた設定は戻してから↑のコマンドを実行しないと、メニューが非表示になるだけです。</p>

<h2>まとめ</h2>

<p>ってことで、とりあえず個人的には一段落。新規タブの作成とかモッサリしたなと思ってた動作が以前のSafari並に快適になった気がします。少なくともメモリー使用量は確実に減ってるので、現状は多くの環境で恩恵があると思います。</p>

<p>前述したようにもっとハードウェアのリソースが潤沢になってくればタブ毎にプロセスを立ち上げるモデルのほうがメリットが強くなってくるし、新しい実装のほうが進化を続けていくのは当然のことなので、将来的にこのような設定は不要になるとは思いますが、「まだデフォルトで有効にしなくても良かったんじゃない？」という気もします。ちはいえここらへんの攻めっぷりはさすがにAppleクオリティーと納得w</p>

<p>しかしブラウザ業界もまだまだ落ち着かないですねぇ。来年はBlinkとかももっと本格化してきてまた荒れるのかなぁ。</p>

                    

                </div>


                    </mt:ignore>
                    <!-- Dummy Content }}} -->

                    <h1><$mt:EntryTitle$></h1>
                    <div id='post-info' class='sub-text'>
                        <mt:If tag="EntryAuthorDisplayName">
                            Posted by <span class="vcard author"><$mt:EntryAuthorLink show_hcard="1"$></span> on <abbr class="published" title="<$mt:EntryDate format_name="iso8601"$>"><$mt:EntryDate format="%x %X"$></abbr>
                        <mt:Else>
                            <abbr class="published" title="<$mt:EntryDate format_name="iso8601"$>"><$mt:EntryDate format="%x %X"$></abbr>
                        </mt:If>
                    </div>

                    <mt:If tag="EntryBody">
                        <$mt:Include module="EntryBody with Keyword"$>
                    </mt:If>

                    <mt:If tag="EntryMore" convert_breaks="0">
                        <$mt:Include module="EntryMore with Keyword"$>
                    </mt:If>

                </div>

                <!-- Social Buttons {{{ -->
                <div id='social-buttons' class='flex flex-social'>
                    <div class="fb-like" data-layout="box_count" data-action="like" data-show-faces="true" data-share="false"></div>
                    <a href="https://twitter.com/share" class="twitter-share-button" data-via="drikin" data-lang="ja" data-count="vertical">ツイート</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                    <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
                    <div class="g-plusone" data-size="tall"></div>
                    <script type="text/javascript">
                    window.___gcfg = {lang: 'ja'};
                    (function() {
                        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                        po.src = 'https://apis.google.com/js/platform.js';
                        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
                    })();
                    </script>
                    <div>
                        <script type="text/javascript" src="//media.line.naver.jp/js/line-button.js?v=20131101" ></script>
                        <script type="text/javascript">
                        new jp.naver.line.media.LineButton({"pc":true,"lang":"ja","type":"e"});
                        </script>
                    </div>
                    <a data-pocket-label="pocket" data-pocket-count="vertical" class="pocket-btn" data-lang="jp"></a>
                    <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
                </div>
                <!--- Social Buttons }}} -->
            </div>

            <div id='right'>
                <!-- Adsense right {{{ -->
                <div id='adsense-right'>
                    <!-- HTML Boilerplate Right -->
                    <ins class="adsbygoogle html-boilerplate-right"
                        style="display:inline-block"
                        data-ad-client="ca-pub-2861930620315189"
                        data-ad-slot="1377257456"></ins>
                    <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                <!-- Adsense right }}} -->

                <!-- ZenBack {{{ -->
                <div id='zenback'>
                    <!-- X:S ZenBackWidget --><div id="zenback-widget-loader"></div><script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var r=Math.ceil((new Date()*1)*Math.random());var j=d.createElement("script");j.id=i;j.async=true;j.src="//w.zenback.jp/v1/?base_uri=http%3A//blog.drikin.com/&nsid=89741841632620263%3A%3A89741847001336796&rand="+r;d.body.appendChild(j);}}(document,"zenback-widget-js");</script><!-- X:E ZenBackWidget -->
                </div>
                <!-- ZenBack }}} -->
            </div>

        </div>


        <div id='bottom' class='flex-column flex-center'>
            <!-- Disqus {{{ -->
            <div id='disqus'>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'driftdiaryxv'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            <!-- Disqus }}} -->

            <!-- Adsense Bottom {{{ -->
            <div id='adsense-bottom'>
                <!-- HTML Boilerplate Bottom -->
                <ins class="adsbygoogle html-boilerplate-bottom"
                    style="display:inline-block"
                    data-ad-client="ca-pub-2861930620315189"
                    data-ad-slot="3563511053"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
            <!-- Adsense Bottom }}} -->
            <div class='footer'>
                Presented by Koh Aoki
            </div>
            <div class='copyright'>
                © drikin.com
            </div>
        </div>

        <!-- Script {{{ -->
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
        <script src="/js/plugins.js"></script>
        <script src="/js/main.js"></script>
        <script type="text/javascript">
            var FLICKREX_API_KEY = "18c9f79a96fd34c3b3f16a93fb0a5d3c"; // this is optional
            var FLICKREX_EXIF_FORMAT = "%camera%(%Lens%), %Focal Length%,  f %aperture%, ISO %ISO Speed%, %Exposure% sec, %Exposure Bias% EV";
            var FLICKREX_EXIF_JQUERY_SELECTOR = "#content img";
        </script>
        <script>(window.jQuery && parseFloat(window.jQuery().jquery) > 1.5) || document.write('<script src="//flickrex.drikin.com/master/vendor/jquery-1.9.0.min.js"><\/script>')</script>
        <script src="//flickrex.drikin.com/master/flickrex.min.js"></script>
        <script src="//flickrex.drikin.com/master/exifex.min.js"></script>
        <!-- Script }}} -->

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. {{{ -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-50655-3');ga('send','pageview');
        </script>
        <!-- Google Analytics }}} -->
    </body>
</html>
<!-- vim:set ft=html fdm=marker expandtab: -->
